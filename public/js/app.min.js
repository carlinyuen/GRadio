var socket=io.connect(window.location.href),app=app||{};$(function(){function getParam(key,source){var result=new RegExp(key+"=([^&]*)","i").exec(source?source:window.location.search);return result&&unescape(result[1])||""}function changeStation(sourceUrl){console.log("changeStation:",sourceUrl),$player[0].pause(),$("source").remove(),$.each(sourceUrl.split(","),function(index,source){source&&source.length&&$(document.createElement("source")).attr("src",source).attr("type","audio/mpeg").prependTo($player)}),setTimeout(function(){$player[0].load(),$player[0].play()},0)}function updateRoomCount(roomCount){$form.attr("data-content",roomCount)}function addMessage($html){$messages.append($html),$messages.scrollTop($messages[0].scrollHeight-$messages.height()),chatCollapsed&&$form.animate({bottom:-($form.height()-6)},TIME_CHATBOX_JIGGLE,"linear",function(){$form.animate({bottom:-$form.height()},TIME_CHATBOX_JIGGLE,"linear")})}function messageReceived(data){console.log("messageReceived:",data),addMessage($(document.createElement("p")).text(data.msg).prepend($(document.createElement("strong")).text(data.username).css({color:data.clientId===userId?color:data.color}))),updateRoomCount(data.roomCount)}function notificationReceived(data){data.msg&&addMessage(data.msg),updateRoomCount(data.roomCount),"disconnect"==data.action&&$("#"+data.clientId).fadeOut("fast",function(){$(this).remove()})}function moveCursor(data){data.clientId==userId||$("#"+data.clientId).length||$(document.createElement("div")).addClass("cursor").attr("id",data.clientId).hide().appendTo("body").fadeIn("fast"),data.clientId!=userId&&$("#"+data.clientId).css({left:($(window).width()-data.w)/2+data.x+"px",top:data.y+"px"})}function initUser(){socket.emit("initUser",{name:username,clientId:userId},function(data){console.log("initUser:",data),$(".cursor").fadeOut("fast",function(){$(this).remove()}),userId=data.clientId,username=data.name,color=data.color,console.log("recent:",data.recentMessages);for(var i=0,l=data.recentMessages.length;l>i;++i)messageReceived(data.recentMessages[i]);updateRoomCount(data.roomCount)})}function socketError(err){console.log("socketError:",err),$(".cursor").fadeOut("fast",function(){$(this).remove()})}function toggleChatBox(){chatCollapsed=!chatCollapsed,$form.animate({bottom:chatCollapsed?-$form.height():0},TIME_CHATBOX_ANIMATION)}var userId,username,color,TIME_CHATBOX_ANIMATION=400,TIME_CHATBOX_HIDE=1e3,TIME_CHATBOX_JIGGLE=50,TIME_REFRESH_RATE=50,$form=$("#chatBox"),$inputField=$("#input"),$messages=$("#messages"),$sendButton=$("#send"),$player=$("#player"),rateLimit=function(callback){var rateHandler;rateHandler||(callback(),rateHandler=setTimeout(function(){rateHandler=null},TIME_REFRESH_RATE))},updateMouseLocation=function(event){socket&&rateLimit(function(){var data={x:event.pageX,y:event.pageY,w:$(window).width(),h:$(window).height()};socket.emit("move",data)})};$("body").on("mousemove",updateMouseLocation),$("body").on("touchmove",updateMouseLocation),$("li a").click(function(event){event.preventDefault();var url=$(this).attr("href"),newSource=getParam("source",url);changeStation(newSource),window.history.pushState(null,$(this).text(),url),$(".navbar").find("li").removeClass("active"),$(this).parent("li").addClass("active")}),$(".navbar-brand").click(function(){alert("Welcome to Carlin's favorite free online radio stations! Feel free to stick around and say hi in the chatter box.")}),socket.on("connect",initUser),socket.on("message",messageReceived),socket.on("notification",notificationReceived),socket.on("move",moveCursor),socket.on("error",socketError),$sendButton.click(function(){var message=$inputField.val();message.length&&socket.emit("message",{msg:message},function(){$inputField.val("")})}),$inputField.keydown(function(e){13==e.keyCode&&$sendButton.trigger("click")}),$form.submit(function(event){event.preventDefault()});var chatCollapsed=!1;$(".collapseButton").click(toggleChatBox),$player[0].volume=.33;var source=getParam("source");source?(console.log("onload source:",source),changeStation(source)):$("li a").get(0).click(),setTimeout(toggleChatBox,TIME_CHATBOX_HIDE)});